# =================================================================================================================================
# Stage "regression"
# =================================================================================================================================

# ---------------------------------------------------------------------------------------------------------------------------------
# GitLab Shared Runners

# ____________________________
# MPCDF new Docker images
# (each providing a toolchain based on a single combination of compiler and MPI variant)

# compare results between intel and gnu (no MPI)
reg.mpcdfci_ifx-latest_vs_gfortran-latest:
  stage: regression
  extends:
    - .mpcdfci_ifx-latest
    - .before_script_modules
    - .script_regression
    - .vars_matrix_run
    - .rules_default
  variables:
    HASH_TAG_1: ${HASH_TAG}
    HASH_TAG_2: ${HASH_TAG}
    CURR_CMP_1: ifx-latest
    CURR_CMP_2: gfortran-latest
    CASENAME_1: ${HASH_TAG_1}_${CURR_CMP_1}_${CMP_MODE}_${OMP_MODE}_mpiOFF
    CASENAME_2: ${HASH_TAG_2}_${CURR_CMP_2}_${CMP_MODE}_${OMP_MODE}_mpiOFF
  allow_failure:
    exit_codes: 5  # warnings
  needs:
    - job: run.mpcdfci_ifx-latest
      artifacts: true
    - job: run.mpcdfci_gfortran-latest
      artifacts: true

# compare results between intel2023 and intel_latest (no MPI)
reg.mpcdfci_ifort-2023_vs_ifx-latest:
  stage: regression
  extends:
    - .mpcdfci_ifx-latest
    - .before_script_modules
    - .script_regression
    - .vars_matrix_run
    - .rules_default
  variables:
    HASH_TAG_1: ${HASH_TAG}
    HASH_TAG_2: ${HASH_TAG}
    CURR_CMP_1: ifort-2023
    CURR_CMP_2: ifx-latest
    CASENAME_1: ${HASH_TAG_1}_${CURR_CMP_1}_${CMP_MODE}_${OMP_MODE}_mpiOFF
    CASENAME_2: ${HASH_TAG_2}_${CURR_CMP_2}_${CMP_MODE}_${OMP_MODE}_mpiOFF
  allow_failure:
    exit_codes: 5  # warnings
  needs:
    - job: run.mpcdfci_ifort-2023
      artifacts: true
    - job: run.mpcdfci_ifx-latest
      artifacts: true

# compare results between intel2023 and intel2024 (no MPI)
reg.mpcdfci_ifort-2023_vs_ifx-2024:
  stage: regression
  extends:
    - .mpcdfci_ifx-latest  # actual compiler not used
    - .before_script_modules
    - .script_regression
    - .vars_matrix_run
    - .rules_default
  variables:
    HASH_TAG_1: ${HASH_TAG}
    HASH_TAG_2: ${HASH_TAG}
    CURR_CMP_1: ifort-2023
    CURR_CMP_2: ifx-2024
    CASENAME_1: ${HASH_TAG_1}_${CURR_CMP_1}_${CMP_MODE}_${OMP_MODE}_mpiOFF
    CASENAME_2: ${HASH_TAG_2}_${CURR_CMP_2}_${CMP_MODE}_${OMP_MODE}_mpiOFF
  allow_failure:
    exit_codes: 5  # warnings
  needs:
    - job: run.mpcdfci_ifort-2023
      artifacts: true
    - job: run.mpcdfci_ifx-2024
      artifacts: true

# compare results between [serial/OpenMP, ifx/gfortran latest] (no MPI)
reg.mpcdfci_ifx-latest_omp-vs-serial:
  stage: regression
  extends:
    - .mpcdfci_ifx-latest
    - .before_script_modules
    - .script_regression
    - .rules_minimal
  parallel:
    matrix:
      - CMP_MODE: ["Release", "Debug"]
  variables:
    CMP_MODE: "Debug"
    OMP_MODE_1: "ompOFF"
    OMP_MODE_2: "ompON"
    CASENAME_1: ${HASH_TAG}_${CURR_CMP}_${CMP_MODE}_${OMP_MODE_1}_mpiOFF
    CASENAME_2: ${HASH_TAG}_${CURR_CMP}_${CMP_MODE}_${OMP_MODE_2}_mpiOFF
    PYTEST_EXTRA_OPTS: "--add-ignore-pattern=Number of OpenMP threads"
  allow_failure:
    exit_codes: 5  # warnings
  needs:
    - job: run.mpcdfci_ifx-latest
      artifacts: true

reg.mpcdfci_gfortran-latest_omp-vs-serial:
  stage: regression
  extends:
    - .mpcdfci_gfortran-latest
    - .before_script_modules
    - .script_regression
    - .rules_default
  parallel:
    matrix:
      - CMP_MODE: ["Release", "Debug"]
  variables:
    OMP_MODE_1: "ompOFF"
    OMP_MODE_2: "ompON"
    CASENAME_1: ${HASH_TAG}_${CURR_CMP}_${CMP_MODE}_${OMP_MODE_1}_mpiOFF
    CASENAME_2: ${HASH_TAG}_${CURR_CMP}_${CMP_MODE}_${OMP_MODE_2}_mpiOFF
    PYTEST_EXTRA_OPTS: "--add-ignore-pattern=Number of OpenMP threads"
  allow_failure:
    exit_codes: 5  # warnings
  needs:
    - job: run.mpcdfci_gfortran-latest
      artifacts: true

# compare results between current and tag branches for Intel compiler (no MPI)
reg.mpcdfci_ifort-2023_vs-tag:
  stage: regression
  extends:
    - .mpcdfci_ifort-2023
    - .before_script_modules
    - .script_regression
    - .vars_matrix_run  # can NOT use .vars_matrix_run_tag here, otherwise HASH_TAG = HASH_TAG_REFERENCE
    - .rules_default
  variables:
    HASH_TAG_1: ${HASH_TAG}
    HASH_TAG_2: ${HASH_TAG_REFERENCE}
    CASENAME_1: ${HASH_TAG_1}_${CURR_CMP}_${CMP_MODE}_${OMP_MODE}_mpiOFF
    CASENAME_2: ${HASH_TAG_2}_${CURR_CMP}_${CMP_MODE}_${OMP_MODE}_mpiOFF
  allow_failure:
    exit_codes: 5  # warnings
  needs:
    - job: run.mpcdfci_ifort-2023
      artifacts: true
    - job: run.mpcdfci_ifort-2023_tag
      artifacts: true

# compare results between current and tag branches for Intel compiler (no MPI)
reg.mpcdfci_intel2024-vs-tag:
  stage: regression
  extends:
    - .mpcdfci_ifx-2024
    - .before_script_modules
    - .script_regression
    - .vars_matrix_run  # can NOT use .vars_matrix_run_tag here, otherwise HASH_TAG = HASH_TAG_REFERENCE
    - .rules_default
  variables:
    HASH_TAG_1: ${HASH_TAG}
    HASH_TAG_2: ${HASH_TAG_REFERENCE}
    CASENAME_1: ${HASH_TAG_1}_${CURR_CMP}_${CMP_MODE}_${OMP_MODE}_mpiOFF
    CASENAME_2: ${HASH_TAG_2}_${CURR_CMP}_${CMP_MODE}_${OMP_MODE}_mpiOFF
  allow_failure:
    exit_codes: 5  # warnings
  needs:
    - job: run.mpcdfci_ifx-2024
      artifacts: true
    - job: run.mpcdfci_ifx-2024_tag
      artifacts: true

# compare results between MPI=ON and MPI=OFF  for Intel compiler
reg.mpcdfci_ifx-latest_mpiON-vs-mpiOFF:
  stage: regression
  extends:
    - .mpcdfci_ifx-latest
    - .before_script_modules
    - .script_regression
    - .rules_minimal
  parallel:
    matrix:
      - CMP_MODE: ["Release"]
        OMP_MODE: ["ompON"]
        MPI_RNKS: ["1","2"]
  variables:
    HASH_TAG_1: ${HASH_TAG}
    HASH_TAG_2: ${HASH_TAG}
    CURR_CMP_1: ifx-latest
    CURR_CMP_2: ifx-impi-latest
    CASENAME_1: ${HASH_TAG_1}_${CURR_CMP_1}_${CMP_MODE}_${OMP_MODE}_mpiOFF
    CASENAME_2: ${HASH_TAG_2}_${CURR_CMP_2}_${CMP_MODE}_${OMP_MODE}_mpiON${MPI_RNKS_MODE}
    MPI_RNKS_MODE: "_nranks${MPI_RNKS}"
    PYTEST_EXTRA_OPTS: "--add-ignore-pattern=['Number of OpenMP threads','Number of MPI tasks']"
  needs:
    - job: run.mpcdfci_ifx-latest
      artifacts: true
    - job: run.mpcdfci_ifx-impi-latest
      artifacts: true
