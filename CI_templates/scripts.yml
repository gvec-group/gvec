# SCRIPT TEMPLATES
# This file contains the templates for the scripts that are used in the CI pipeline.
# =================================================================================================================================


# =================================================================================================================================
# TEMPLATES INDEPENDENT OF STAGE
# =================================================================================================================================

# execute the bash script in `CI_setup` to setup the environment, e.g. by loading modules
.before_script_modules:
  before_script:
    - echo -e "\e[0Ksection_start:`date +%s`:setup-env[collapsed=true]\r\e[0KSetup Environment"
    - echo ${CMAKE_HOSTNAME} ${CURR_CMP}
    - . ./CI_setup/${CMAKE_HOSTNAME}_setup_${CURR_CMP}
    - echo "Fortran compiler is ${FC}"
    - git status
    - echo -e "\e[0Ksection_end:`date +%s`:setup-env\r\e[0K"

.after_script_basic:
  after_script:
    - echo "CI_JOB_STATUS is ${CI_JOB_STATUS}"
    - if [[ "${CI_JOB_NAME}" = *"_slurm"* ]]; then sacct --name ${SLURM_JOB_NAME} -o JobID,JobName,State,NNodes,NCPUS,NTasks; fi

# =================================================================================================================================
# TEMPLATES FOR STAGE "env" (printout the environment for future reference)
# =================================================================================================================================

.script_env:
  script:
    - echo "Pipeline environment for branch $CI_COMMIT_REF_NAME and tag $HASH_TAG_REFERENCE"
    - echo $CI_RUNNER_DESCRIPTION
    - echo $CI_RUNNER_TAGS
    - echo -e "\e[0Ksection_start:`date +%s`:printenv[collapsed=true]\r\e[0KEnvironment Variables"
    - printenv
    - echo -e "\e[0Ksection_end:`date +%s`:printenv\r\e[0K"
    - echo $OMP_NUM_THREADS
    - echo $SHELL
    - ls -las
    - date


# =================================================================================================================================
# TEMPLATES FOR STAGE "build" 
# =================================================================================================================================

.script_build:
  script:
    - echo -e "\e[0Ksection_start:`date +%s`:pre-build[collapsed=true]\r\e[0KPrepare Build"
    - pwd
    - echo "Building on branch ${HASH_TAG} with ${CURR_CMP} in ${CMP_MODE} mode, OMP=${OMP_MODE:3} and MPI=${MPI_MODE:3}"
    - echo "CMAKE_HOSTNAME is ${CMAKE_HOSTNAME}"
    - echo "is ${HASH_TAG} the same as ${CI_COMMIT_REF_NAME}?"
    - if [ ${HASH_TAG} != ${CI_COMMIT_REF_NAME} ]; then git fetch --tags; git checkout ${HASH_TAG}; fi
    - git tag
    - echo "DRY-RUN OF THE FULL PYTEST CALL"
    - python --version
    - python -m pytest --version
    - mkdir _dry_run
    - echo -e "\e[0Ksection_start:`date +%s`:pytest-dryrun[collapsed=true]\r\e[0KPytest dry-run"
    - ${PYTEST_EXEC_CMD} --log-file=log_dryrun.txt --rundir=_dry_run --refdir=_dry_run --postdir=_dry_post --dry-run
    - echo -e "\e[0Ksection_end:`date +%s`:pytest-dryrun\r\e[0K"
    - rm -rf _dry_* 
    - echo "BUILDNAME is ${BUILDNAME}"
    - rm -rf build_${BUILDNAME}; mkdir -p build_${BUILDNAME}
    - cd build_${BUILDNAME}; pwd
    - echo -e "\e[0Ksection_end:`date +%s`:pre-build\r\e[0K"
    # BUILD
    - echo -e "\e[0Ksection_start:`date +%s`:cmake[collapsed=true]\r\e[0KCMake"
    - echo "cmake -DCMAKE_HOSTNAME=${CMAKE_HOSTNAME} -DCMAKE_BUILD_TYPE=${CMP_MODE} -DUSE_OPENMP=${OMP_MODE:3} -DUSE_MPI=${MPI_MODE:3} ${CMAKE_DEF_OPTS} ../."
    - cmake -DCMAKE_HOSTNAME=${CMAKE_HOSTNAME} -DCMAKE_BUILD_TYPE=${CMP_MODE} -DUSE_OPENMP=${OMP_MODE:3} -DUSE_MPI=${MPI_MODE:3} ${CMAKE_DEF_OPTS} ../. |tee ../log_${BUILDNAME}_cmake.txt
    - echo -e "\e[0Ksection_end:`date +%s`:cmake\r\e[0K"
    - echo -e "\e[0Ksection_start:`date +%s`:make[collapsed=true]\r\e[0KMake"
    - make -j VERBOSE=1 |tee ../log_${BUILDNAME}_make.txt
    - echo -e "\e[0Ksection_end:`date +%s`:make\r\e[0K"
    - cd ..; echo "... BUILD PHASE FINISHED!"
  artifacts:
    name: "build_${CI_PIPELINE_ID}_${CI_JOB_ID}_${BUILDNAME}"
    paths:
      - build_${BUILDNAME}
      - log_${BUILDNAME}_*.txt
    expire_in: 2 days #1 week
    when: always


# =================================================================================================================================
# TEMPLATES FOR STAGE "run"
# =================================================================================================================================

# also required in "post"
.before_script_exportvars:
  before_script:
    - echo -e "\e[0Ksection_start:`date +%s`:exportvars[collapsed=true]\r\e[0KExport environment variables"
    # Retrieving the allocation name in a separate shell is the uglier part
        #export RUN_PRFX="srun --immediate=${SRUN_TIMEOUT} --time=${SLURM_TIMELIMIT} --nodes=${SLURM_NNODES} --mem=${SLURM_MEM_PER_NODE} --cpus-per-task=${OMP_NUM_THR} --job-name=${SLURM_JOB_NAME}";
    - if [[ "${CI_JOB_NAME}" = *"_slurm"* ]]; then
        export RUN_PRFX="srun --immediate=${SRUN_TIMEOUT} --cpus-per-task=${OMP_NUM_THR}";
      else
        if [ ${MPI_MODE} = 'mpiON' ]; then export RUN_PRFX="mpirun -np ${MPI_RNKS}"; else export RUN_PRFX=""; fi
      fi
    #- if [ ${MPI_MODE} = 'mpiON' ]; then export RUN_PRFX="mpirun -np ${MPI_RNKS}"; else export RUN_PRFX=""; fi
    - if [ ${OMP_MODE} = 'ompON' ]; then export OMP_NUM_THREADS=${OMP_NUM_THR}; fi
    - echo "hostname:" $HOSTNAME
    - echo "HASH_TAG is ${HASH_TAG}"
    - echo "BUILDNAME is ${BUILDNAME} >> build_${BUILDNAME}/"
    - echo "CASENAME is ${CASENAME} >> CIrun_${CASENAME}/"
    - echo "Running with ${CURR_CMP} in $CMP_MODE mode, OMP=${OMP_MODE:3} and MPI=${MPI_MODE:3}";
    - echo "Run prefix:" ${RUN_PRFX}
    - if [[ "${CI_JOB_NAME}" = *"_slurm"* ]]; then
        echo "SLURM_JOB_NAME:" ${SLURM_JOB_NAME};
        echo "SLURM_MEM_PER_NODE:" ${SLURM_MEM_PER_NODE};
        echo "SLURM_NNODES:" ${SLURM_NNODES};
        echo "SLURM_NTASKS_PER_NODE:" ${SLURM_NTASKS_PER_NODE};
        echo "SLURM_CPUS_PER_TASK:" ${SLURM_CPUS_PER_TASK};
        echo "SLURM_NTASKS_PER_CORE:" ${SLURM_NTASKS_PER_CORE};
        echo "OpenMP number of threads:" $OMP_NUM_THREADS ", should be =" ${OMP_NUM_THR};
      fi
    - python --version
    - python -m pytest --version
    - echo -e "\e[0Ksection_end:`date +%s`:exportvars\r\e[0K"

.script_run:
  script:
    - echo -e "\e[0Ksection_start:`date +%s`:pre-run[collapsed=true]\r\e[0KPrepare Run"
    - export PYTEST_DIR_OPTS="--builddir=build_${BUILDNAME} --rundir=CIrun_${CASENAME}"
    - echo ${PYTEST_EXEC_CMD} --log-file=log_pytest_run_norestart.txt -m "${PYTEST_MARKER_OPTS} and run_stage and (not restart)" $PYTEST_DIR_OPTS -k "${PYTEST_KEY_OPTS}" --run-prefix "${RUN_PRFX}" --dry-run
    -      ${PYTEST_EXEC_CMD} --log-file=log_pytest_run_norestart.txt -m "${PYTEST_MARKER_OPTS} and run_stage and (not restart)" $PYTEST_DIR_OPTS -k "${PYTEST_KEY_OPTS}" --dry-run
    # avoid submission of SLURM jobs for the --dry-run
    #-      ${PYTEST_EXEC_CMD} --log-file=log_pytest_run_norestart.txt -m "${PYTEST_MARKER_OPTS} and run_stage and (not restart)" $PYTEST_DIR_OPTS -k "${PYTEST_KEY_OPTS}" --run-prefix "${RUN_PRFX}" --dry-run
    - rm -rf CIrun_${CASENAME}
    - echo -e "\e[0Ksection_end:`date +%s`:pre-run\r\e[0K"
    # RUN
    - echo -e "\e[0Ksection_start:`date +%s`:run[collapsed=true]\r\e[0KRun"
    - echo "OpenMP number of threads:" $OMP_NUM_THREADS
    # pytest: no restart
    - ${PYTEST_EXEC_CMD}
      --log-file=log_pytest_run_norestart.txt 
      -m "${PYTEST_MARKER_OPTS} and run_stage and (not restart)" 
      $PYTEST_DIR_OPTS 
      -k "${PYTEST_KEY_OPTS}" 
      --run-prefix "${RUN_PRFX}" 
      --junitxml=pytest.xml 
      --annotations=annotations.json
    # pytest: restart
    - ${PYTEST_EXEC_CMD} 
      --log-file=log_pytest_run_restart.txt 
      -m "${PYTEST_MARKER_OPTS} and run_stage and restart" 
      $PYTEST_DIR_OPTS
      -k "${PYTEST_KEY_OPTS}" 
      --run-prefix "${RUN_PRFX}" 
      --junitxml=pytest-restart.xml
      --annotations=annotations.json
    - echo -e "\e[0Ksection_end:`date +%s`:run\r\e[0K"
  artifacts:
    name: "run_${CI_PIPELINE_ID}_${CI_JOB_ID}_${CASENAME}"
    paths:
      - log_pytest_run_norestart.txt
      - log_pytest_run_restart.txt
      - CIrun_${CASENAME}
    expire_in: 2 days #1 week
    when: always
    reports:
      junit:
        - pytest.xml
        - pytest-restart.xml
      annotations:
        - annotations.json


# =================================================================================================================================
# TEMPLATES FOR STAGE "regression"
# =================================================================================================================================

.script_regression:
  script:
    - echo -e "\e[0Ksection_start:`date +%s`:pre-reg[collapsed=true]\r\e[0KPrepare Regression"
    - python --version
    - python -m pytest --version
    - echo $SHELL
    - set +e #continue script after command fails, gitlab otherwise only returns 0 or 1
    - echo CIrun_${CASENAME_1}
    - echo CIrun_${CASENAME_2}
    - export PYTEST_DIR_OPTS="--rundir=CIrun_${CASENAME_1} --refdir=CIrun_${CASENAME_2}"
    - echo ${PYTEST_EXEC_CMD} --log-file=log_pytest_regression.txt -m "${PYTEST_MARKER_OPTS} and regression_stage" -k "${PYTEST_KEY_OPTS}" $PYTEST_DIR_OPTS "${PYTEST_EXTRA_OPTS}" --dry-run
    -      ${PYTEST_EXEC_CMD} --log-file=log_pytest_regression.txt -m "${PYTEST_MARKER_OPTS} and regression_stage" -k "${PYTEST_KEY_OPTS}" $PYTEST_DIR_OPTS "${PYTEST_EXTRA_OPTS}" --dry-run
    - echo -e "\e[0Ksection_end:`date +%s`:pre-reg\r\e[0K"
    - echo -e "\e[0Ksection_start:`date +%s`:regression[collapsed=true]\r\e[0KRegression"
    - echo ${PYTEST_EXEC_CMD} --log-file=log_pytest_regression.txt -m "${PYTEST_MARKER_OPTS} and regression_stage" -k "${PYTEST_KEY_OPTS}" $PYTEST_DIR_OPTS "${PYTEST_EXTRA_OPTS}" --junitxml=pytest.xml
    # pytest: regression
    - ${PYTEST_EXEC_CMD} 
      --log-file=log_pytest_regression.txt 
      -m "${PYTEST_MARKER_OPTS} and regression_stage" 
      -k "${PYTEST_KEY_OPTS}" 
      $PYTEST_DIR_OPTS 
      "${PYTEST_EXTRA_OPTS}" 
      --junitxml=pytest.xml
      --annotations=annotations.json
      || RET=$?
    - echo -e "\e[0Ksection_end:`date +%s`:regression\r\e[0K"
    - exit $RET
  artifacts:
    name: "reg_${CI_PIPELINE_ID}_${CI_JOB_ID}_${CASENAME_1}_vs_${CASENAME_2}"
    paths:
      - log_pytest_regression.txt
      - CIrun_${CASENAME_1}
      - CIrun_${CASENAME_2}
    expire_in: 2 days #1 week
    when: always #on_failure
    reports:
      junit: pytest.xml
      annotations: annotations.json


# =================================================================================================================================
# TEMPLATES FOR STAGE "post"
# =================================================================================================================================

.script_post:
  script:
    - echo -e "\e[0Ksection_start:`date +%s`:pre-post[collapsed=true]\r\e[0KPrepare Postprocessing"
    - export PYTEST_DIR_OPTS="--builddir=build_${BUILDNAME} --rundir=CIrun_${CASENAME} --postdir=CIpost_${CASENAME}"
    - ${PYTEST_EXEC_CMD} --log-file=log_pytest_post.txt -m "${PYTEST_MARKER_OPTS} and post_stage" -k "${PYTEST_KEY_OPTS}" $PYTEST_DIR_OPTS --junitxml=pytest.xml --dry-run
    - rm -rf CIpost_${CASENAME}
    - echo -e "\e[0Ksection_end:`date +%s`:pre-post\r\e[0K"
    # POST
    - echo -e "\e[0Ksection_start:`date +%s`:post[collapsed=true]\r\e[0KPostprocessing"
    - ${PYTEST_EXEC_CMD} 
      --log-file=log_pytest_post.txt 
      -m "${PYTEST_MARKER_OPTS} and post_stage" 
      -k "${PYTEST_KEY_OPTS}" 
      $PYTEST_DIR_OPTS 
      --junitxml=pytest.xml
      --annotations=annotations.json
    - echo -e "\e[0Ksection_end:`date +%s`:post\r\e[0K"
  artifacts:
    name: "post_${CI_PIPELINE_ID}_${CI_JOB_ID}_${CASENAME}"
    paths:
      - log_pytest_post.txt
      - CIpost_${CASENAME}
    expire_in: 1 day #1 week
    when: always
    reports:
      junit: pytest.xml
      annotations: annotations.json

# =================================================================================================================================
# TEMPLATES FOR STAGE "postprocessing" + "converter"
# =================================================================================================================================

.script_conv:
  script:
    - echo -e "\e[0Ksection_start:`date +%s`:pre-conv[collapsed=true]\r\e[0KPrepare converter Postprocessing"
    - export PYTEST_DIR_OPTS="--builddir=build_${BUILDNAME} --rundir=CIrun_${CASENAME} --convdir=CIconv_${CASENAME}"
    - ${PYTEST_EXEC_CMD} --log-file=log_pytest_conv.txt -m "${PYTEST_MARKER_OPTS} and converter_stage and (not restart)" -k "not highres" $PYTEST_DIR_OPTS --junitxml=pytest.xml --dry-run
    - rm -rf CIconv_${CASENAME}
    - echo -e "\e[0Ksection_end:`date +%s`:pre-conv\r\e[0K"
    # CONVERTER TESTS
    - echo -e "\e[0Ksection_start:`date +%s`:conv[collapsed=true]\r\e[0K converter Postprocessing"
    - ${PYTEST_EXEC_CMD} 
      --log-file=log_pytest_conv.txt 
      -m "${PYTEST_MARKER_OPTS} and converter_stage and (not restart)" 
      -k "not highres" 
      $PYTEST_DIR_OPTS 
      --junitxml=pytest.xml
      --annotations=annotations.json
    - echo -e "\e[0Ksection_end:`date +%s`:conv\r\e[0K"
  artifacts:
    name: "conv_${CI_PIPELINE_ID}_${CI_JOB_ID}_${CASENAME}"
    paths:
      - log_pytest_conv.txt
      - CIconv_${CASENAME}
    expire_in: 2 days #1 week
    when: always
    reports:
      junit: pytest.xml
      annotations: annotations.json
