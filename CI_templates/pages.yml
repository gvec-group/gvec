# =================================================================================================================================
# Stage "publish" - generate documentation
# =================================================================================================================================

pages:
  stage: publish
  extends:
    - .mpcdfci_gfortran-latest
    - .before_script_modules
    - .rules_pages
  variables:
    GIT_STRATEGY: clone
    FORD_PREFIX: /gvec  # prefix for the absolute path to the generated ford docs in the header
    BUILDNAME: ${HASH_TAG}_${CI_HOSTNAME}_gfortran-latest_Release_ompON_mpiOFF
  script:
    - source CI_templates/helpers.bash
    # install graphviz/dot & urw-fonts - required by ford to generate the graphs
    - start_details install "Install Requirements"
    - module load graphviz/2.44
    - zypper install -y urw-fonts
    # python environment to build the documentation
    # (venv needs to be outside the docs folder, otherwise autodoc will be confused)
    # try using the venv from the build-pip otherwise create a new one
    - echo ${BUILDNAME}
    - ls venv_*
    - |
      if [ -d "venv_${BUILDNAME}" ]; then
      source "venv_${BUILDNAME}/bin/activate"
      export PYTHONPATH=venv_${BUILDNAME}/lib/python*/site-packages/
      else
      python -m venv venv_docs
      source venv_docs/bin/activate
      fi
    - which python
    - cd docs
    - pip install -r requirements.txt
    - start_details piplist "Installed Python Packages"
    - pip list
    - end_details piplist
    - end_details install
    # run ford
    - export VERSION=$(git describe --tags --always --dirty); echo $VERSION
    - mkdir extra -p
    - start_details ford "Generate Ford Documentation"
    - ford ford/ford.md -r "$VERSION"
    - end_details ford
    # run sphinx
    - start_details sphinx "Generate Sphinx Documentation"
    - make html
    - end_details sphinx
    - cd ..
  publish: docs/build/html
  artifacts:
    paths:
      - docs/build/html
  needs:
    - job: build.mpcdfci_gfortran-latest_py
      artifacts: true
      optional: true
